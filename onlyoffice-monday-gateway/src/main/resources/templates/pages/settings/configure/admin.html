<div>
    <div>
        <div th:replace="~{atoms/input/base}"></div>
        <div th:replace="~{atoms/input/label}"></div>
        <div th:replace="~{atoms/button/secondary}"></div>
        <div th:replace="~{atoms/loader/spinner}"></div>

        <div th:replace="~{molecules/button/loader}"></div>
        <div th:replace="~{molecules/input/password}"></div>
        <div th:replace="~{molecules/input/text}"></div>

        <div th:replace="~{organisms/form/common}"></div>
        <div th:replace="~{organisms/form/settings}"></div>
        <div th:replace="~{organisms/information/configuration}"></div>
    </div>
    <main x-data="configureAdminData" class="flex flex-col justify-center items-center min-h-screen overflow-hidden p-4 sm:p-8" role="main">
        <div style="display: none;">
            <div id="ds-frame"></div>
        </div>
        <div class="h-full w-full flex justify-center items-center py-8">
            <div class="w-full max-w-[960px] flex flex-col md:flex-row items-start space-y-8 md:space-y-0 md:space-x-8">
                <div class="w-full max-w-[500px]">
                    <x-configuration-information class="w-full"></x-configuration-information>
                </div>
                <form class="p-8 rounded-lg shadow-lg"
                      :class="[
                          $store?.darkMode?.on ? 'bg-background-dark' : 'bg-white'
                      ]"
                      style="width: 384px; transition: border-color 0.3s ease;"
                      @submit="toggleSubmit"
                      :hx-post="path"
                      hx-swap="none"
                      hx-trigger="submit"
                >
                    <x-docspace-settings-form></x-docspace-settings-form>
                </form>
            </div>
        </div>
    </main>
    <script>
        function configureAdminData() {
            return {
                admin: true,
                login: false,
                change: false,
                path: '/api/1.0/settings',
                disabled: false,
                loading: false,
                url: "",
                email: "",
                password: "",
                loginError: "[[${page?.data?.login?.error}]]",
                loginSuccess: "[[${page?.data?.login?.success}]]",
                setError() {
                    this.error = true;
                    this.loading = false;
                    this.disabled = false;
                },
                toggleSubmit() {
                    this.disabled = true;
                    this.loading = true;
                },
                init() {
                    this.monday = mondaySdk();
                    htmx.on('htmx:beforeRequest', async (evt) => {
                        const { boardId } = (await mondaySdk().get("context")).data;
                        if (evt.detail.pathInfo.finalRequestPath !== this.path) {
                            return;
                        }

                        evt.preventDefault();
                        try {
                            const timeout = setTimeout(() => this.setError(), 6500);
                            const frame = window.DocSpace.SDK.initSystem({
                                src: this.url,
                                frameId: 'ds-frame',
                                events: {
                                    onAppReady: async () => {
                                        try {
                                            clearTimeout(timeout);
                                            const settings = await DocSpace.SDK.frames['ds-frame'].getHashSettings();
                                            const hash = await DocSpace.SDK.frames['ds-frame'].createHash(this.password, settings);
                                            const login = await DocSpace.SDK.frames['ds-frame'].login(this.email, hash);
                                            const me = await DocSpace.SDK.frames['ds-frame'].getUserInfo();
                                            if (login && login.url) {
                                                fetch(this.path, {
                                                    method: 'POST',
                                                    body: JSON.stringify({
                                                        "docspace_user_id": me.id,
                                                        "docspace_url": this.url,
                                                        "docspace_email": this.email,
                                                        "docspace_hash": hash,
                                                    }),
                                                    headers: {
                                                        ...evt.detail.requestConfig.headers,
                                                        'Content-Type': 'application/json',
                                                    },
                                                }).then(response => {
                                                    if (!response.ok) {
                                                        this.monday.execute("notice", {
                                                           message: this.loginError,
                                                           type: "error",
                                                           timeout: 10000,
                                                        });
                                                        throw new Error('Could not persist user credentials');
                                                    } else {
                                                        this.monday.execute("notice", {
                                                           message: this.loginSuccess,
                                                           type: "success",
                                                           timeout: 10000,
                                                        });
                                                        htmx.ajax('GET', `/views/settings/refresh?boardId=${boardId}`, { target: '#content', swap: 'innerHTML' });
                                                    }
                                                }).catch(error => {
                                                    this.setError();
                                                });
                                            } else {
                                                this.setError();
                                            }
                                        } catch (error) {
                                            this.setError();
                                        } finally {
                                            await DocSpace.SDK.frames['ds-frame'].destroyFrame();
                                        }
                                    },
                                    onAppError: (error) => this.setError()
                                }
                            });
                        } catch {
                            this.setError();
                        }
                    });
                },
            }
        }
    </script>
</div>